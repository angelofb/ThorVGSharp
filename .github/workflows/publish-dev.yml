name: Publish Development Package

on:
  workflow_dispatch:
    inputs:
      base_version:
        description: 'Base version (e.g., 0.1.0)'
        required: false
        default: '0.1.0'
        type: string

jobs:
  publish-dev:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Generate development version
        id: version
        run: |
          BASE_VERSION="${{ inputs.base_version }}"
          DATE=$(date -u +%Y%m%d)
          SHORT_SHA=$(git rev-parse --short=7 HEAD)
          DEV_VERSION="${BASE_VERSION}-dev.${DATE}.${SHORT_SHA}"
          echo "DEV_VERSION=${DEV_VERSION}" >> "$GITHUB_ENV"
          echo "Development version: ${DEV_VERSION}"

      - name: Pack
        run: dotnet pack source/ThorVGSharp/ThorVGSharp.csproj -c Release -p:Version=$DEV_VERSION -o out/

      - name: Push to GitHub Packages
        run: |
          dotnet nuget add source \
            --username ${{ github.actor }} \
            --password ${{ secrets.GITHUB_TOKEN }} \
            --store-password-in-clear-text \
            --name github \
            "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json"

          dotnet nuget push out/*.nupkg \
            --source "github" \
            --api-key ${{ secrets.GITHUB_TOKEN }} \
            --skip-duplicate

      - name: Output package information
        run: |
          echo "‚úÖ Development package published successfully!"
          echo ""
          echo "üì¶ Package: ThorVGSharp"
          echo "üè∑Ô∏è  Version: $DEV_VERSION"
          echo "üìç Repository: https://github.com/${{ github.repository }}/packages"
          echo ""
          echo "To use this package, add the GitHub Packages source:"
          echo "dotnet nuget add source https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json -n github"
